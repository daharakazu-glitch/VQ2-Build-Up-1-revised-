<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build Up 1 Exercises: Nouns & Articles</title>
    <!-- エラーハンドリング用スクリプト -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("Global Error Caught:", message, error);
            return false;
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
        }
        .control-button:hover {
            transform: scale(1.1);
            transition: transform 0.2s;
        }
        .highlight {
            color: #16A34A; /* green-600 */
            font-weight: bold;
        }
        .placeholder {
            color: #3B82F6; /* blue-500 */
            font-weight: bold;
        }
        .explanation-panel, .recognition-panel, .feedback-panel {
            transition: all 0.3s ease-in-out;
        }
        .recording {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        /* 選択肢ボタンのスタイル */
        .option-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            background-color: #ffffff;
            border-radius: 0.5rem;
            font-size: 1.125rem;
            font-weight: 500;
            color: #111827;
            border: 2px solid #e5e7eb;
            transition: all 0.2s;
            cursor: pointer;
        }
        .option-btn:hover:not(:disabled) {
            background-color: #f3f4f6;
            border-color: #d1d5db;
        }
        .option-btn.correct {
            background-color: #dcfce7; /* green-100 */
            border-color: #16a34a; /* green-600 */
            color: #14532d; /* green-900 */
        }
        .option-btn.incorrect {
            background-color: #fee2e2; /* red-100 */
            border-color: #dc2626; /* red-600 */
            color: #7f1d1d; /* red-900 */
        }
        /* 入力フィールドのスタイル */
        .input-blank {
            border-bottom: 2px solid #3b82f6;
            background-color: #eff6ff;
            padding: 0 0.25rem;
            color: #1e40af;
            font-weight: bold;
            outline: none;
            transition: all 0.2s;
            min-width: 60px;
            text-align: center;
        }
        .input-blank:focus {
            background-color: #dbeafe;
            border-bottom-color: #2563eb;
        }
        .input-blank.correct {
            background-color: #dcfce7;
            border-bottom-color: #16a34a;
            color: #15803d;
        }
        .input-blank.incorrect {
            background-color: #fee2e2;
            border-bottom-color: #dc2626;
            color: #b91c1c;
        }
        .input-full {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.375rem;
            margin-top: 0.5rem;
            font-size: 1rem;
            transition: all 0.2s;
        }
        .input-full:focus {
            border-color: #3b82f6;
            outline: none;
        }
        .input-full.correct {
            border-color: #16a34a;
            background-color: #f0fdf4;
        }
        .input-full.incorrect {
            border-color: #dc2626;
            background-color: #fef2f2;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Build Up 1 Exercises</h1>
            <p class="text-gray-600 mt-2">名詞と冠詞 (Nouns and Articles)</p>
        </header>

        <main class="space-y-6" id="main-content">
            <section>
                <h2 class="text-2xl font-bold text-gray-700 border-l-4 border-blue-500 pl-4 mb-4">1. 適切な語句の選択</h2>
                <p class="mb-4 text-gray-600 ml-4 text-sm">正解だと思う選択肢をクリックしてください。</p>
                <div id="sentences-1" class="space-y-4"></div>
            </section>
            <section>
                <h2 class="text-2xl font-bold text-gray-700 border-l-4 border-green-500 pl-4 mb-4">2. 語句補充</h2>
                <p class="mb-4 text-gray-600 ml-4 text-sm">空欄に入力して「Check」ボタンを押してください。</p>
                <div id="sentences-2" class="space-y-4"></div>
            </section>
            <section>
                <h2 class="text-2xl font-bold text-gray-700 border-l-4 border-purple-500 pl-4 mb-4">3. 語句整序</h2>
                <p class="mb-4 text-gray-600 ml-4 text-sm">並べ替えた英文を入力して「Check」ボタンを押してください。</p>
                <div id="sentences-4" class="space-y-4"></div>
            </section>
            <section>
                <h2 class="text-2xl font-bold text-gray-700 border-l-4 border-red-500 pl-4 mb-4">4. 和文英訳</h2>
                <p class="mb-4 text-gray-600 ml-4 text-sm">英文を入力して「Check」ボタンを押してください。</p>
                <div id="sentences-5" class="space-y-4"></div>
            </section>
        </main>
    </div>

    <script>
        try {
            // PDFのデータに基づく問題リスト (修正版)
            const sentences = [
                // 1. Multiple Choice (Mapped to Category 1)
                { 
                    id: 1, category: '1', 
                    en: "Ryoko got some information from Mr. Chapman.", 
                    jp: "リョウコはチャップマン先生からいくつかの情報を得た。", 
                    explanation: "information（情報）は不可算名詞です。s はつかず、many ではなく much や some を用います。homework, advice, knowledge もすべて不可算名詞で s はつきません。", 
                    answer: "some information",
                    options: ["a. much homeworks", "b. lots of advices", "c. many knowledge", "d. some information"]
                },
                { 
                    id: 2, category: '1', 
                    en: "The local police are very strict with traffic violations.", 
                    jp: "地元の警察は交通違反にとても厳しい。", 
                    explanation: "police（警察）は集合名詞で、形は単数でも常に複数扱いをします。したがって動詞は are を用います。", 
                    answer: "police are",
                    options: ["a. polices is", "b. polices are", "c. police is", "d. police are"]
                },
                { 
                    id: 3, category: '1', 
                    en: "I could not make room on the desk for more than two computers.", 
                    jp: "机の上にはコンピュータを2台以上置くスペースを作れなかった。", 
                    explanation: "「場所・空間」という意味での room は不可算名詞です。「部屋」という意味の場合は可算名詞ですが、ここではスペースの意味なので room となります。", 
                    answer: "room",
                    options: ["a. room", "b. a room", "c. rooms", "d. many rooms"]
                },
                { 
                    id: 4, category: '1', 
                    en: "The senior students helped me move some large furniture.", 
                    jp: "先輩たちが大きな家具を運ぶのを手伝ってくれた。", 
                    explanation: "furniture（家具）は不可算名詞です。s はつかず、a few ではなく some や much を用います。", 
                    answer: "some large furniture",
                    options: ["a. a few large furniture", "b. a few large furnitures", "c. some large furniture", "d. some large furnitures"]
                },
                { 
                    id: 5, category: '1', 
                    en: "Let's go for a walk in the woods.", 
                    jp: "森へ散歩に行こう。", 
                    explanation: "wood は「木材」なら不可算ですが、s をつけて the woods とすると「森」という意味になります。", 
                    answer: "the woods",
                    options: ["a. an wood", "b. wood", "c. the woods", "d. woods"]
                },
                { 
                    id: 6, category: '1', 
                    en: "I'd like to make friends with someone who is good at English.", 
                    jp: "英語が得意な誰かと友達になりたい。", 
                    explanation: "「～と友達になる」は make friends with ... という熟語を用います。相手と自分を含めて複数になるため friends と複数形にします。", 
                    answer: "make friends",
                    options: ["a. be friend", "b. being friends", "c. make a friend", "d. make friends"]
                },
                { 
                    id: 7, category: '1', 
                    en: "I was wondering if you could give me some advice.", 
                    jp: "いくつかアドバイスをいただけないかと思っているのですが。", 
                    explanation: "advice（助言）は不可算名詞です。an や s はつかず、数える場合は some advice や a piece of advice とします。", 
                    answer: "some advice",
                    options: ["a. a few advices", "b. many advices", "c. little advice", "d. some advice"]
                },
                { 
                    id: 8, category: '1', 
                    en: "Mr. Ito changed trains at Kanayama and took the train for Toyohashi.", 
                    jp: "伊藤さんは金山で電車を乗り換えて、豊橋行きの電車に乗った。", 
                    explanation: "「乗り換える」は change trains です。乗ってきた電車とこれから乗る電車の2つが関わるため、複数形にします。", 
                    answer: "trains",
                    options: ["a. train", "b. a train", "c. its train", "d. trains"]
                },
                { 
                    id: 9, category: '1', 
                    en: "Neither of the two boys likes spinach.", 
                    jp: "その2人の少年のどちらもホウレンソウが好きではない。", 
                    explanation: "特定の2人を指しているため、定冠詞 the が必要です。Neither of the two ... となります。", 
                    answer: "the two",
                    options: ["a. the two", "b. the three", "c. two", "d. three"]
                },
                { 
                    id: 10, category: '1', 
                    en: "Betty didn't want to help John. She had not been on good terms with him.", 
                    jp: "ベティはジョンを助けたくなかった。彼女は彼と仲が良くなかったのだ。", 
                    explanation: "be on good terms with ... で「～と仲が良い（良い間柄である）」という熟語です。terms は「間柄・関係」の意味で複数形を用います。", 
                    answer: "terms",
                    options: ["a. opinions", "b. terms", "c. regards", "d. manners"]
                },
                { 
                    id: 11, category: '1', 
                    en: "We arrived there by bus in half an hour.", 
                    jp: "私たちはバスで30分でそこに到着した。", 
                    explanation: "hour は発音が母音で始まるため、不定冠詞は an を用います。half an hour で「30分（半時間）」です。", 
                    answer: "an",
                    options: ["a. the", "b. a", "c. an", "d. every"]
                },
                { 
                    id: 12, category: '1', 
                    en: "I was having trouble with the sound system in my house because the equipment was faulty.", 
                    jp: "その機器が故障していたため、私は家の音響システムで困っていた。", 
                    explanation: "equipment（機器・装置）は不可算名詞です。単数扱いで動詞は was を用います。特定の機器を指すので the をつけます。", 
                    answer: "the equipment was",
                    options: ["a. equipment was", "b. equipments were", "c. the equipment was", "d. the equipments were"]
                },
                { 
                    id: 13, category: '1', 
                    en: "She has a nice piano, but unfortunately, I don't have an instrument to play.", 
                    jp: "彼女は素敵なピアノを持っているが、残念ながら私は演奏する楽器を持っていない。", 
                    explanation: "instrument（楽器）は可算名詞です。不特定の1つを指すため an instrument とします。", 
                    answer: "an instrument",
                    options: ["a. an instrument", "b. instrument", "c. instruments", "d. the instrument"]
                },
                { 
                    id: 14, category: '1', 
                    en: "I have years of experience in the computer industry.", 
                    jp: "私にはコンピュータ業界での長年の経験がある。", 
                    explanation: "experience は「経験」という抽象的な意味では不可算ですが、「長年の」と言う場合は years of experience という表現が一般的です。", 
                    answer: "years of experience",
                    options: ["a. year of experience", "b. years of experience", "c. a year of experiences", "d. years of experiences"]
                },

                // 2. Fill in the blanks (Japanese to English) (Mapped to Category 2)
                { 
                    id: 15, category: '2', 
                    en: "Three women came to buy bread.", 
                    jp: "3人の女性がパンを買いに来た。", 
                    explanation: "「3人の女性」Three women、「パン」bread（不可算名詞）。", 
                    answer: ["Three women", "bread"] 
                },
                { 
                    id: 16, category: '2', 
                    en: "I'll find new information online.", 
                    jp: "新しい情報をインターネットで見つけるつもりだ。", 
                    explanation: "information は不可算名詞なので an はつきません。new information とします。", 
                    answer: "new information" 
                },
                { 
                    id: 17, category: '2', 
                    en: "Can you pass me two pieces of paper?", 
                    jp: "紙を2枚とってくれますか。", 
                    explanation: "paper（紙）は不可算名詞なので、枚数を数えるときは pieces of または sheets of を使います。解答例：two pieces [sheets] of paper", 
                    answer: "two pieces of paper" 
                },
                { 
                    id: 18, category: '2', 
                    en: "Jack was having lunch when a fire broke out in the restaurant.", 
                    jp: "レストランで火事が起きた時、ジャックは昼食を食べていた。", 
                    explanation: "食事名の lunch には冠詞をつけません。fire は「火」という物質なら不可算ですが、「火事」という意味では可算名詞になり、ここでは「ある1つの火事」なので a fire となります。", 
                    answer: ["lunch", "a fire"] 
                },

                // 4. Translation (Mapped to Category 5)
                { 
                    id: 23, category: '5', 
                    en: "My father reads the newspaper every morning.", 
                    jp: "父は毎朝、新聞を読む。", 
                    answer: "My father reads the newspaper every morning.", 
                    explanation: "newspaper は可算名詞です。「新聞を読む」は read the newspaper とするのが一般的です。" 
                },
                { 
                    id: 24, category: '5', 
                    en: "Our teacher gave us a lot of homework.", 
                    jp: "先生は私たちに宿題をたくさん出した。", 
                    answer: "Our teacher gave us a lot of homework.", 
                    explanation: "「先生」は Our teacher とします。homework は不可算名詞なので、many ではなく a lot of または much を用います。" 
                },
                { 
                    id: 25, category: '5', 
                    en: "They eat steak with a knife and fork.", 
                    jp: "彼らはナイフとフォークでステーキを食べる。", 
                    answer: "They eat steak with a knife and fork.", 
                    explanation: "「ナイフとフォーク」はセットで扱うことが多く、a knife and fork とまとめて a をつけることがあります（または a knife and a fork）。道具を表す前置詞は with を使います。" 
                },
                { 
                    id: 26, category: '5', 
                    en: "The weather can be hard to predict. Sometimes it's sunny but cold, sometimes it's cloudy but warm.", 
                    jp: "晴れて寒かったり、曇って暖かかったりと、天気は予測しづらい。", 
                    answer: "The weather can be hard to predict. Sometimes it's sunny but cold, sometimes it's cloudy but warm.", 
                    explanation: "「天気」は the weather。「予測する」は predict。別解：It is hard to predict the weather as it's sometimes sunny but cold, and sometimes cloudy but warm." 
                }
            ];

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            let mediaRecorder;
            let mediaStream;
            let americanVoice = null; 

            function loadAndSetVoice() {
                try {
                    const voices = speechSynthesis.getVoices();
                    if (voices.length === 0) return;
                    americanVoice = voices.find(voice => voice.name === 'Google US English') ||
                                    voices.find(voice => voice.name === 'Samantha') ||
                                    voices.find(voice => voice.lang === 'en-US'); 
                } catch (e) {
                    console.warn("Speech Synthesis Voice Load Error:", e);
                }
            }

            loadAndSetVoice(); 
            if (speechSynthesis && speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadAndSetVoice;
            }

            if (SpeechRecognition) {
                try {
                    recognition = new SpeechRecognition();
                    recognition.continuous = false;
                    recognition.lang = 'en-US';
                    recognition.interimResults = false;
                    recognition.maxAlternatives = 1;
                } catch (e) {
                    console.warn("SpeechRecognition Init Error:", e);
                }
            }

            function normalizeText(text) {
                return text.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").replace(/\s\s+/g, ' ').trim().toLowerCase();
            }

            // 類似度計算ロジック
            function calculateSimilarity(s1, s2) {
                let longer = s1;
                let shorter = s2;
                if (s1.length < s2.length) {
                    longer = s2;
                    shorter = s1;
                }
                let longerLength = longer.length;
                if (longerLength === 0) return 1.0;
                return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
            }

            function editDistance(s1, s2) {
                s1 = s1.toLowerCase();
                s2 = s2.toLowerCase();
                const costs = new Array();
                for (let i = 0; i <= s1.length; i++) {
                    let lastValue = i;
                    for (let j = 0; j <= s2.length; j++) {
                        if (i == 0) costs[j] = j;
                        else {
                            if (j > 0) {
                                let newValue = costs[j - 1];
                                if (s1.charAt(i - 1) != s2.charAt(j - 1))
                                    newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                                costs[j - 1] = lastValue;
                                lastValue = newValue;
                            }
                        }
                    }
                    if (i > 0) costs[s2.length] = lastValue;
                }
                return costs[s2.length];
            }

            function handleRecording(sentence, recordButton, resultPanel) {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    resultPanel.innerHTML = `<p class="text-red-500 font-bold">エラー: マイク機能が使用できません。</p>`;
                    return;
                }
                if (!recognition) {
                    resultPanel.innerHTML = `<p class="text-red-500">お使いのブラウザは音声認識に対応していません。</p>`;
                    return;
                }
                if (recordButton.classList.contains('recording')) {
                    try { recognition.stop(); } catch(e) {}
                    return;
                }
                
                resultPanel.innerHTML = ''; 

                navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                        mediaStream = stream; 
                        mediaRecorder = new MediaRecorder(stream);
                        let audioChunks = [];

                        mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                        mediaRecorder.onstop = () => {
                            if (audioChunks.length === 0) return;
                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            const audioUrl = URL.createObjectURL(audioBlob);
                            setTimeout(() => {
                                if (resultPanel.innerHTML.trim() !== '' && !resultPanel.querySelector('.playback-div')) {
                                    const playbackDiv = document.createElement('div');
                                    playbackDiv.className = 'playback-div flex items-center space-x-2 mt-3 pt-3 border-t border-gray-200';
                                    playbackDiv.innerHTML = `
                                        <button class="control-button p-2 rounded-full bg-indigo-500 text-white hover:bg-indigo-600 focus:outline-none">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                                        </button>
                                        <p class="text-sm text-gray-600">自分の音声を確認する</p>
                                    `;
                                    const audioPlayer = new Audio(audioUrl);
                                    playbackDiv.querySelector('button').onclick = () => audioPlayer.play();
                                    resultPanel.appendChild(playbackDiv);
                                }
                            }, 100);
                            audioChunks = [];
                        };

                        recognition.start();
                        recognition.onstart = () => {
                            recordButton.classList.add('recording', 'bg-red-500');
                            recordButton.classList.remove('bg-green-500');
                            resultPanel.innerHTML = `<p class="text-gray-500">録音中...</p>`;
                            if(mediaRecorder.state === 'inactive') mediaRecorder.start();
                        };

                        recognition.onend = () => {
                            recordButton.classList.remove('recording', 'bg-red-500');
                            recordButton.classList.add('bg-green-500');
                            if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
                            if (mediaStream) mediaStream.getTracks().forEach(track => track.stop());
                        };

                        recognition.onresult = (event) => {
                            if (!event.results?.[0]?.[0]?.transcript) {
                                resultPanel.innerHTML = `<p class="text-yellow-600">認識できませんでした。</p>`;
                                return;
                            }
                            const transcript = event.results[0][0].transcript;
                            const score = Math.round(calculateSimilarity(normalizeText(sentence), normalizeText(transcript)) * 100);

                            let colorClass = score >= 85 ? 'text-green-600' : (score >= 65 ? 'text-yellow-600' : 'text-red-600');
                            let feedback = score >= 85 ? '素晴らしい！' : (score >= 65 ? '惜しい！' : 'もう一度！');
                            
                            resultPanel.innerHTML = `
                                <p class="text-gray-800">あなたの発音: 「${transcript}」</p>
                                <div class="flex items-center mt-2">
                                    <p class="font-bold ${colorClass}">${feedback}</p>
                                    <p class="ml-4 text-sm text-gray-600">スコア: ${score}点</p>
                                </div>`;
                        };
                    }).catch(err => {
                        resultPanel.innerHTML = `<p class="text-red-500">マイクアクセスエラー</p>`;
                    });
            }

            // 選択肢テキストから記号部分を除去するヘルパー関数
            function getOptionText(text) {
                // "a. "などのプレフィックスを除去して本体のみ返す
                const parts = text.split('. ');
                return parts.length > 1 ? parts.slice(1).join('. ') : text;
            }

            function createSentenceCard(sentence, displayId) {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow-md';
                
                const contentAndControls = document.createElement('div');
                contentAndControls.className = 'flex items-start space-x-4';

                const numberDiv = document.createElement('div');
                numberDiv.className = 'flex-shrink-0 bg-gray-200 text-gray-700 font-bold rounded-full h-8 w-8 flex items-center justify-center text-sm';
                numberDiv.textContent = String(displayId);

                const textContentDiv = document.createElement('div');
                textContentDiv.className = 'flex-grow w-full'; // w-full for input width

                const enP = document.createElement('p');
                enP.className = 'text-lg text-gray-800 font-medium leading-relaxed';

                const jpP = document.createElement('p');
                jpP.className = 'text-gray-600 mt-1';
                jpP.textContent = sentence.jp;

                // Controls
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'flex flex-col items-center space-y-2 ml-2 flex-shrink-0';

                const audioButton = document.createElement('button');
                audioButton.className = 'control-button p-2 rounded-full bg-blue-500 text-white hover:bg-blue-600 focus:outline-none';
                audioButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>`;
                audioButton.onclick = () => {
                    if (speechSynthesis.speaking) speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(sentence.en);
                    if (americanVoice) utterance.voice = americanVoice;
                    speechSynthesis.speak(utterance);
                };

                const recordButton = document.createElement('button');
                recordButton.className = 'control-button p-2 rounded-full bg-green-500 text-white hover:bg-green-600 focus:outline-none';
                recordButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v3a3 3 0 01-3 3z" /></svg>`;
                const recognitionPanel = document.createElement('div');
                recognitionPanel.className = 'recognition-panel mt-3';
                recordButton.onclick = () => handleRecording(sentence.en, recordButton, recognitionPanel);

                const buttonGroup = document.createElement('div');
                buttonGroup.className = 'flex items-center space-x-2 mt-2';
                const toggleAnswerButton = document.createElement('button');
                toggleAnswerButton.className = 'control-button text-xs px-2 py-1 bg-yellow-400 text-yellow-800 rounded-md hover:bg-yellow-500';
                toggleAnswerButton.textContent = '解答表示';
                const toggleExplanationButton = document.createElement('button');
                toggleExplanationButton.className = 'control-button text-xs px-2 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300';
                toggleExplanationButton.textContent = '解説';

                // Feedback panel for interactive checks
                const feedbackPanel = document.createElement('div');
                feedbackPanel.className = 'feedback-panel mt-2 text-sm font-bold hidden';

                let isAnswerShown = false;

                // --- RENDERING LOGIC BASED ON CATEGORY ---
                
                // Category 1: Multiple Choice
                if (sentence.category === '1') {
                    jpP.classList.add('hidden'); // デフォルト非表示
                    const toggleJpButton = document.createElement('button');
                    toggleJpButton.className = 'control-button text-xs px-2 py-1 bg-indigo-100 text-indigo-700 rounded-md hover:bg-indigo-200';
                    toggleJpButton.textContent = '日本語訳';
                    toggleJpButton.onclick = () => {
                        jpP.classList.toggle('hidden');
                    };
                    buttonGroup.appendChild(toggleJpButton);

                    const optionsDiv = document.createElement('div');
                    optionsDiv.className = 'mt-4 space-y-2'; 
                    
                    // Replace answer in sentence with ( )
                    const hiddenHTML = sentence.en.replace(sentence.answer, `<span class='placeholder font-bold text-xl'>( &emsp; )</span>`); 
                    const correctHTML = sentence.en.replace(sentence.answer, `<span class='highlight text-xl'>${sentence.answer}</span>`);
                    enP.innerHTML = hiddenHTML;

                    sentence.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'option-btn';
                        btn.textContent = opt;
                        btn.onclick = () => {
                            // 厳密な判定ロジックに変更 (Q14バグ修正)
                            const optionText = getOptionText(opt);
                            // 完全一致判定 (トリムして空白の差異を吸収)
                            const isCorrect = optionText.trim() === sentence.answer.trim();

                            // Reset styles for all buttons
                            Array.from(optionsDiv.children).forEach(c => {
                                c.classList.remove('correct', 'incorrect');
                            });
                            
                            if (isCorrect) {
                                btn.classList.add('correct');
                                feedbackPanel.innerHTML = `<span class="text-green-600">Correct! 正解です。</span>`;
                                enP.innerHTML = correctHTML; // Show correct text
                            } else {
                                btn.classList.add('incorrect');
                                feedbackPanel.innerHTML = `<span class="text-red-600">Try Again. 不正解です。</span>`;
                            }
                            feedbackPanel.classList.remove('hidden');
                        };
                        optionsDiv.appendChild(btn);
                    });
                    
                    textContentDiv.appendChild(enP);
                    textContentDiv.appendChild(optionsDiv); 
                    textContentDiv.appendChild(feedbackPanel); // Add feedback here

                    toggleAnswerButton.onclick = () => {
                        isAnswerShown = !isAnswerShown;
                        enP.innerHTML = isAnswerShown ? correctHTML : hiddenHTML;
                        toggleAnswerButton.textContent = isAnswerShown ? '問題文表示' : '解答表示';
                        
                        if (isAnswerShown) {
                             // Show correct option style if revealing answer
                             Array.from(optionsDiv.children).forEach(btn => {
                                 // Strict match logic for show answer as well
                                 if (getOptionText(btn.textContent).trim() === sentence.answer.trim()) {
                                     btn.classList.add('correct');
                                 }
                             });
                         } else {
                             // Reset state when hiding answer (Fix: can return to original state)
                             Array.from(optionsDiv.children).forEach(btn => {
                                 btn.classList.remove('correct', 'incorrect');
                             });
                             feedbackPanel.classList.add('hidden');
                         }
                    };

                // Category 2: Fill in blanks
                } else if (sentence.category === '2') {
                    let answers = Array.isArray(sentence.answer) ? sentence.answer : [sentence.answer];
                    let hiddenHTML = sentence.en;
                    let correctHTML = sentence.en;
                    
                    // Generate inputs with unique IDs to avoid replacement issues
                    answers.forEach((ans, index) => {
                         // Use a temporary token for replacement first
                        const token = `__INPUT_TOKEN_${index}__`;
                        hiddenHTML = hiddenHTML.replace(ans, token);
                        correctHTML = correctHTML.replace(ans, `<span class='highlight'>${ans}</span>`);
                    });

                    // Replace tokens with input elements
                    answers.forEach((ans, index) => {
                         const token = `__INPUT_TOKEN_${index}__`;
                         const width = Math.max(ans.length * 10, 60) + 'px'; // approximate width
                         const inputHTML = `<input type="text" class="input-blank" style="width:${width}" data-answer="${ans}" placeholder="?">`;
                         hiddenHTML = hiddenHTML.replace(token, inputHTML);
                    });

                    enP.innerHTML = hiddenHTML;
                    textContentDiv.appendChild(enP);

                    // Add Check Button
                    const checkContainer = document.createElement('div');
                    checkContainer.className = 'mt-3';
                    const checkButton = document.createElement('button');
                    checkButton.className = 'bg-indigo-500 text-white px-4 py-1 rounded text-sm hover:bg-indigo-600 transition';
                    checkButton.textContent = 'Check Answer';
                    checkButton.onclick = () => {
                        const inputs = enP.querySelectorAll('input');
                        let allCorrect = true;
                        inputs.forEach(input => {
                            const userVal = normalizeText(input.value);
                            const correctVal = normalizeText(input.dataset.answer);
                            if (userVal === correctVal) {
                                input.classList.add('correct');
                                input.classList.remove('incorrect');
                            } else {
                                input.classList.add('incorrect');
                                input.classList.remove('correct');
                                allCorrect = false;
                            }
                        });
                        
                        if (allCorrect) {
                            feedbackPanel.innerHTML = `<span class="text-green-600">Great job! 全問正解です。</span>`;
                        } else {
                             feedbackPanel.innerHTML = `<span class="text-red-600">いくつかの答えが違います。</span>`;
                        }
                        feedbackPanel.classList.remove('hidden');
                    };
                    checkContainer.appendChild(checkButton);
                    textContentDiv.appendChild(checkContainer);
                    textContentDiv.appendChild(feedbackPanel);


                    toggleAnswerButton.onclick = () => {
                        isAnswerShown = !isAnswerShown;
                        // For inputs, we might want to just show the text version or fill the inputs
                        // Here we toggle the text display for simplicity, as per original requirement
                        enP.innerHTML = isAnswerShown ? correctHTML : hiddenHTML;
                        // Re-attach event listeners if we switch back to hiddenHTML (inputs)
                        if (!isAnswerShown) {
                           // Inputs are re-created, so previous values are lost, which is expected behavior for reset
                           feedbackPanel.classList.add('hidden');
                        }
                        toggleAnswerButton.textContent = isAnswerShown ? '解答非表示' : '解答表示';
                        checkButton.style.display = isAnswerShown ? 'none' : 'inline-block';
                    };

                // Category 4: Scrambled
                } else if (sentence.category === '4') {
                    const scrambledHTML = sentence.en.replace(sentence.answer, `<span class='placeholder text-sm bg-gray-100 p-1 rounded'>${sentence.scrambled}</span>`);
                    const correctHTML = sentence.en.replace(sentence.answer, `<span class='highlight'>${sentence.answer}</span>`);
                    enP.innerHTML = scrambledHTML;
                    textContentDiv.appendChild(enP);

                    // Input for scrambled sentence
                    const inputDiv = document.createElement('div');
                    inputDiv.className = 'mt-2';
                    const inputField = document.createElement('input');
                    inputField.type = 'text';
                    inputField.className = 'input-full';
                    inputField.placeholder = '並べ替えた文を入力してください';
                    
                    const checkButton = document.createElement('button');
                    checkButton.className = 'bg-indigo-500 text-white px-4 py-1 rounded text-sm hover:bg-indigo-600 transition mt-2';
                    checkButton.textContent = 'Check Answer';
                    
                    checkButton.onclick = () => {
                        const userVal = normalizeText(inputField.value);
                        // Compare with the full correct part (sentence.answer)
                        const correctVal = normalizeText(sentence.answer);
                        
                        if (userVal.includes(correctVal) || correctVal.includes(userVal) && userVal.length > 5) { // Simple loose check
                             inputField.classList.add('correct');
                             inputField.classList.remove('incorrect');
                             feedbackPanel.innerHTML = `<span class="text-green-600">Correct!</span>`;
                        } else {
                             inputField.classList.add('incorrect');
                             inputField.classList.remove('correct');
                             feedbackPanel.innerHTML = `<span class="text-red-600">Try again.</span>`;
                        }
                         feedbackPanel.classList.remove('hidden');
                    };

                    inputDiv.appendChild(inputField);
                    inputDiv.appendChild(checkButton);
                    textContentDiv.appendChild(inputDiv);
                    textContentDiv.appendChild(feedbackPanel);

                    toggleAnswerButton.onclick = () => {
                        isAnswerShown = !isAnswerShown;
                        enP.innerHTML = isAnswerShown ? correctHTML : scrambledHTML;
                        toggleAnswerButton.textContent = isAnswerShown ? '問題文表示' : '解答表示';
                        if (!isAnswerShown) {
                            feedbackPanel.classList.add('hidden');
                            inputField.classList.remove('correct', 'incorrect');
                            inputField.value = '';
                        }
                    };

                // Category 5: Translation
                } else if (sentence.category === '5') {
                    enP.innerHTML = `<span class="placeholder italic text-gray-400">以下に英文を入力してください</span>`;
                    textContentDiv.appendChild(enP);

                    const inputDiv = document.createElement('div');
                    inputDiv.className = 'mt-2';
                    const inputField = document.createElement('textarea');
                    inputField.className = 'input-full';
                    inputField.rows = 2;
                    inputField.placeholder = '英文を入力...';
                    
                    const checkButton = document.createElement('button');
                    checkButton.className = 'bg-indigo-500 text-white px-4 py-1 rounded text-sm hover:bg-indigo-600 transition mt-2';
                    checkButton.textContent = 'Check Answer';

                    checkButton.onclick = () => {
                        const userVal = normalizeText(inputField.value);
                        const correctVal = normalizeText(sentence.en);
                        
                        // Translation is tricky, but we'll check for exact match normalized for this exercise
                        if (userVal === correctVal) {
                             inputField.classList.add('correct');
                             inputField.classList.remove('incorrect');
                             feedbackPanel.innerHTML = `<span class="text-green-600">Perfect!</span>`;
                        } else {
                             inputField.classList.add('incorrect');
                             inputField.classList.remove('correct');
                             feedbackPanel.innerHTML = `<span class="text-red-600">Check spelling or grammar.</span>`;
                        }
                         feedbackPanel.classList.remove('hidden');
                    };
                    
                    inputDiv.appendChild(inputField);
                    inputDiv.appendChild(checkButton);
                    textContentDiv.appendChild(inputDiv);
                    textContentDiv.appendChild(feedbackPanel);

                    const correctHTML = `<span class="highlight">${sentence.en}</span>`;
                    
                    toggleAnswerButton.onclick = () => {
                        isAnswerShown = !isAnswerShown;
                        enP.innerHTML = isAnswerShown ? correctHTML : `<span class="placeholder italic text-gray-400">以下に英文を入力してください</span>`;
                        toggleAnswerButton.textContent = isAnswerShown ? '問題文表示' : '解答表示';
                         if (!isAnswerShown) {
                            feedbackPanel.classList.add('hidden');
                            inputField.classList.remove('correct', 'incorrect');
                            inputField.value = '';
                        }
                    };
                }

                textContentDiv.appendChild(jpP);
                buttonGroup.appendChild(toggleAnswerButton);
                buttonGroup.appendChild(toggleExplanationButton);
                controlsDiv.appendChild(audioButton);
                controlsDiv.appendChild(recordButton);
                controlsDiv.appendChild(buttonGroup);

                contentAndControls.appendChild(numberDiv);
                contentAndControls.appendChild(textContentDiv);
                contentAndControls.appendChild(controlsDiv);

                const explanationPanel = document.createElement('div');
                explanationPanel.className = 'explanation-panel hidden mt-3 pt-3 border-t border-gray-200 bg-blue-50 p-3 rounded';
                explanationPanel.innerHTML = `<p class="text-sm text-blue-900"><span class="font-bold">解説:</span> ${sentence.explanation}</p>`;
                
                toggleExplanationButton.onclick = () => explanationPanel.classList.toggle('hidden');

                card.appendChild(contentAndControls);
                card.appendChild(explanationPanel);
                card.appendChild(recognitionPanel);

                return card;
            }

            function renderSentences() {
                const containers = {
                    '1': document.getElementById('sentences-1'),
                    '2': document.getElementById('sentences-2'),
                    '4': document.getElementById('sentences-4'),
                    '5': document.getElementById('sentences-5'),
                };

                const categoryCounters = { '1': 0, '2': 0, '4': 0, '5': 0 };

                sentences.forEach(sentence => {
                    if (containers[sentence.category]) {
                        categoryCounters[sentence.category]++;
                        containers[sentence.category].appendChild(createSentenceCard(sentence, categoryCounters[sentence.category]));
                    }
                });
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', renderSentences);
            } else {
                renderSentences();
            }

        } catch (e) {
            console.error(e);
        }
    </script>
</body>
</html>